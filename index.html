<!DOCTYPE HTML>
<html>
<head>
    <title>Point to a Direction Test</title>
    <script>
        let compassHeading = 0;

        // Start watching location and listening for orientation changes
        function startTracking() {
            if (navigator.geolocation) {
                // Start watching the device's location
                navigator.geolocation.watchPosition(
                    updateArrowDirection,
                    showError,
                    { enableHighAccuracy: true, maximumAge: 0 }
                );

                // Listen for device orientation changes (compass heading)
                window.addEventListener("deviceorientationabsolute", updateCompassHeading, true);
            } else {
                document.getElementById("info").innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        // Update the compass heading from the device's orientation
        function updateCompassHeading(event) {
            // Use event.alpha to get the compass heading (in degrees)
            compassHeading = event.alpha || 0;
        }

        function updateArrowDirection(location) {
            // Get the phone’s current GPS coordinates
            const phoneLatitude = location.coords.latitude;
            const phoneLongitude = location.coords.longitude;

            // Destination coordinates (e.g., Musée du Louvre, Paris)
            const destinationLatitude = 1.30864; 
            const destinationLongitude = 103.84955;

            // Calculate the bearing angle to the destination
            const bearingToDestination = calculateBearing(phoneLatitude, phoneLongitude, destinationLatitude, destinationLongitude);

            // Adjust the bearing with the current compass heading
            const adjustedBearing = (bearingToDestination - compassHeading + 360) % 360;

            // Rotate the arrow to the adjusted bearing
            const arrow = document.getElementById('arrow');
            arrow.style.transform = `rotate(${adjustedBearing}deg)`;

            // Display information
            const info = document.getElementById("info");
            info.innerHTML = `
                Longitude: ${phoneLongitude}<br>
                Latitude: ${phoneLatitude}<br>
                Compass Heading: ${compassHeading.toFixed(0)}<br>
                Bearing to Destination: ${bearingToDestination.toFixed(0)}<br>
                Arrow Angle: ${adjustedBearing.toFixed(0)}
            `;
        }

        function calculateBearing(lat1, lng1, lat2, lng2) {
            const dLon = toRad(lng2 - lng1);
            lat1 = toRad(lat1);
            lat2 = toRad(lat2);
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            const rad = Math.atan2(y, x);
            const brng = toDeg(rad);
            return (brng + 360) % 360;
        }

        function toRad(deg) {
            return deg * Math.PI / 180;
        }

        function toDeg(rad) {
            return rad * 180 / Math.PI;
        }

        function showError(error) {
            const info = document.getElementById("info");
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    info.innerHTML = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    info.innerHTML = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    info.innerHTML = "The request to get user location timed out.";
                    break;
                case error.UNKNOWN_ERROR:
                    info.innerHTML = "An unknown error occurred.";
                    break;
            }
        }           
    </script>
</head>
<body onload="startTracking()">
    <img id="map" src="map.png" style="position: absolute; top: 20px; left: 20px;">
    <img id="arrow" src="arrow.png" style="position: absolute; top: 8px; left: 105px; width: 150px; height: 150px;">
    <div id="info" style="position: absolute; top: 340px; left: 20px; font-family: sans-serif; font-size: 11px;"></div>       
</body>
</html>
